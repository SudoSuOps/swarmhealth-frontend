<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diabetes Companion - SwarmHealth</title>
    <meta name="description" content="Free AI companion for diabetes support. No data collected. Always free.">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* Dark mode colors - matching index.html */
            --dark-900: #0a0a0a;
            --dark-800: #121212;
            --dark-700: #1a1a1a;
            --dark-600: #242424;
            --dark-500: #2a2a2a;
            --dark-400: #333333;
            --dark-300: #444444;
            --green-400: #4ade80;
            --green-500: #22c55e;
            --green-600: #16a34a;
            --green-700: #15803d;
            --gray-500: #6b7280;
            --gray-400: #9ca3af;
            --gray-300: #d1d5db;
            --gray-200: #e5e7eb;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--dark-900);
            color: var(--gray-200);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        header {
            background: var(--dark-800);
            border-bottom: 1px solid var(--dark-500);
            padding: 0.75rem 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .back-btn {
            color: var(--gray-400);
            text-decoration: none;
            font-size: 1.25rem;
        }

        .back-btn:hover {
            color: var(--green-400);
        }

        .companion-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .companion-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--green-500), var(--green-600));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .companion-name h2 {
            font-size: 1rem;
            font-weight: 600;
            color: var(--gray-200);
        }

        .companion-name p {
            font-size: 0.75rem;
            color: var(--green-400);
        }

        .header-actions {
            display: flex;
            gap: 0.5rem;
        }

        .header-btn {
            padding: 0.5rem 1rem;
            border: 1px solid var(--dark-500);
            border-radius: 8px;
            background: var(--dark-700);
            color: var(--gray-300);
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .header-btn:hover {
            border-color: var(--green-500);
            color: var(--green-400);
            background: var(--dark-600);
        }
        
        /* Chat Container */
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
        }
        
        /* Messages */
        .message {
            display: flex;
            gap: 0.75rem;
            max-width: 85%;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }
        
        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .message.companion .message-avatar {
            background: linear-gradient(135deg, var(--green-500), var(--green-600));
            font-size: 1rem;
        }
        
        .message.user .message-avatar {
            background: var(--dark-400);
            color: var(--gray-200);
            font-size: 0.875rem;
            font-weight: 600;
        }

        .message-content {
            background: var(--dark-700);
            padding: 0.875rem 1rem;
            border-radius: 16px;
            color: var(--gray-200);
        }

        .message.companion .message-content {
            border-bottom-left-radius: 4px;
            border: 1px solid var(--dark-500);
        }

        .message.user .message-content {
            background: var(--green-600);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message-content p {
            line-height: 1.5;
            font-size: 0.9375rem;
        }

        .message-time {
            font-size: 0.7rem;
            color: var(--gray-500);
            margin-top: 0.25rem;
        }

        .message.user .message-time {
            color: rgba(255, 255, 255, 0.7);
            text-align: right;
        }

        /* Typing indicator */
        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 0.5rem 0;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: var(--green-400);
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-4px); }
        }
        
        /* Welcome Message */
        .welcome-card {
            background: var(--dark-800);
            border: 1px solid var(--dark-500);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }

        .welcome-card h3 {
            color: var(--green-400);
            font-size: 1.125rem;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .welcome-card p {
            color: var(--gray-300);
            font-size: 0.9375rem;
            line-height: 1.6;
            margin-bottom: 1rem;
        }

        .welcome-prompts {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .prompt-btn {
            background: var(--dark-700);
            border: 1px solid var(--dark-400);
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            color: var(--green-400);
            cursor: pointer;
            transition: all 0.2s;
        }

        .prompt-btn:hover {
            background: var(--green-600);
            color: white;
            border-color: var(--green-600);
        }
        
        /* Input Area */
        .input-container {
            background: var(--dark-800);
            border-top: 1px solid var(--dark-500);
            padding: 1rem;
        }

        .input-wrapper {
            max-width: 800px;
            margin: 0 auto;
            display: flex;
            gap: 0.75rem;
            align-items: flex-end;
        }

        .input-field {
            flex: 1;
            background: var(--dark-700);
            border: 1px solid var(--dark-500);
            border-radius: 24px;
            padding: 0.75rem 1.25rem;
            font-size: 1rem;
            font-family: inherit;
            resize: none;
            min-height: 48px;
            max-height: 120px;
            line-height: 1.5;
            transition: all 0.2s;
            color: var(--gray-200);
        }

        .input-field::placeholder {
            color: var(--gray-500);
        }

        .input-field:focus {
            outline: none;
            border-color: var(--green-500);
            background: var(--dark-600);
        }

        .send-btn {
            width: 48px;
            height: 48px;
            background: var(--green-600);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 1.25rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .send-btn:hover:not(:disabled) {
            background: var(--green-500);
            transform: scale(1.05);
        }

        .send-btn:disabled {
            background: var(--dark-400);
            cursor: not-allowed;
        }

        /* Privacy Notice */
        .privacy-notice {
            text-align: center;
            font-size: 0.75rem;
            color: var(--gray-500);
            padding: 0.5rem;
            background: var(--dark-800);
        }

        .privacy-notice a {
            color: var(--green-400);
            text-decoration: none;
        }
        
        /* Responsive */
        @media (max-width: 640px) {
            .message {
                max-width: 95%;
            }
            
            .header-actions {
                display: none;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-left">
            <a href="/" class="back-btn">‚Üê</a>
            <div class="companion-info">
                <div class="companion-avatar">ü©∏</div>
                <div class="companion-name">
                    <h2>Diabetes Companion</h2>
                    <p>‚óè Online ‚Ä¢ Here to listen</p>
                </div>
            </div>
        </div>
        <div class="header-actions">
            <button class="header-btn" onclick="clearChat()">Clear Chat</button>
            <button class="header-btn" onclick="toggleInfo()">‚ÑπÔ∏è About</button>
        </div>
    </header>
    
    <div class="chat-container" id="chatContainer">
        <div class="welcome-card">
            <h3>üíö Welcome</h3>
            <p>
                I'm here to listen and support you through the daily challenges of diabetes. 
                I was trained on conversations with real people living with diabetes, so I understand 
                the frustrations, the victories, and everything in between.
            </p>
            <p style="font-size: 0.8rem; color: var(--gray-500);">
                I'm not a doctor and can't give medical advice. For medical concerns, please consult your healthcare team.
            </p>
            <div class="welcome-prompts">
                <button class="prompt-btn" onclick="sendPrompt('I had a rough night with my blood sugar')">Rough night with blood sugar</button>
                <button class="prompt-btn" onclick="sendPrompt('I\'m frustrated with my pump')">Frustrated with my pump</button>
                <button class="prompt-btn" onclick="sendPrompt('I need to vent about carb counting')">Carb counting struggles</button>
                <button class="prompt-btn" onclick="sendPrompt('Anyone else exhausted from this?')">Feeling exhausted</button>
            </div>
        </div>
    </div>
    
    <div class="privacy-notice">
        üîí Your messages are never stored or used for training. 
        <a href="/privacy">Learn more</a>
    </div>
    
    <div class="input-container">
        <div class="input-wrapper">
            <textarea 
                class="input-field" 
                id="messageInput" 
                placeholder="Share what's on your mind..."
                rows="1"
                onkeydown="handleKeyDown(event)"
                oninput="autoResize(this)"
            ></textarea>
            <button class="send-btn" id="sendBtn" onclick="sendMessage()">
                ‚Üí
            </button>
        </div>
    </div>
    
    <script>
        // API endpoint - SwarmHealth API server
        const API_URL = 'https://api.swarmhealth.io/api/chat';
        
        // Chat history for context
        let chatHistory = [];
        
        function autoResize(el) {
            el.style.height = 'auto';
            el.style.height = Math.min(el.scrollHeight, 120) + 'px';
        }
        
        function handleKeyDown(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }
        
        function sendPrompt(text) {
            document.getElementById('messageInput').value = text;
            sendMessage();
        }
        
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Clear input
            input.value = '';
            autoResize(input);
            
            // Hide welcome card
            const welcome = document.querySelector('.welcome-card');
            if (welcome) welcome.style.display = 'none';
            
            // Add user message
            addMessage(message, 'user');
            
            // Show typing indicator
            const typingId = showTyping();
            
            // Add to history
            chatHistory.push({ role: 'user', content: message });
            
            try {
                // Call API
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: message,
                        history: chatHistory.slice(-10) // Last 10 messages for context
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('API response:', data);

                // Remove typing indicator
                hideTyping(typingId);

                // Add companion response
                const reply = data.response || "I hear you. Living with diabetes is hard, and it's okay to feel frustrated. I'm here if you want to talk more about it.";
                addMessage(reply, 'companion');
                
                // Add to history
                chatHistory.push({ role: 'assistant', content: reply });
                
            } catch (error) {
                console.error('Chat API error:', error);
                hideTyping(typingId);

                // Fallback response if API fails
                const fallbackResponses = [
                    "I hear you. Managing diabetes is a lot of work, and it's okay to feel overwhelmed sometimes. What's been the hardest part lately?",
                    "That sounds really frustrating. The constant attention diabetes requires can be exhausting. How are you taking care of yourself today?",
                    "Thank you for sharing that with me. Diabetes burnout is real, and you're not alone in feeling this way. What would help you feel a little better right now?",
                    "I understand. Some days are harder than others with diabetes. Remember that you're doing your best, and that's enough. What's one small win you've had recently?",
                ];
                
                const reply = fallbackResponses[Math.floor(Math.random() * fallbackResponses.length)];
                addMessage(reply, 'companion');
                chatHistory.push({ role: 'assistant', content: reply });
            }
        }
        
        function addMessage(text, type) {
            const container = document.getElementById('chatContainer');
            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            
            if (type === 'companion') {
                messageDiv.innerHTML = `
                    <div class="message-avatar">ü©∏</div>
                    <div class="message-content">
                        <p>${escapeHtml(text)}</p>
                        <div class="message-time">${time}</div>
                    </div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="message-avatar">You</div>
                    <div class="message-content">
                        <p>${escapeHtml(text)}</p>
                        <div class="message-time">${time}</div>
                    </div>
                `;
            }
            
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }
        
        function showTyping() {
            const container = document.getElementById('chatContainer');
            const id = 'typing-' + Date.now();
            
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message companion';
            typingDiv.id = id;
            typingDiv.innerHTML = `
                <div class="message-avatar">ü©∏</div>
                <div class="message-content">
                    <div class="typing-indicator">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
            `;
            
            container.appendChild(typingDiv);
            container.scrollTop = container.scrollHeight;
            
            return id;
        }
        
        function hideTyping(id) {
            const el = document.getElementById(id);
            if (el) el.remove();
        }
        
        function clearChat() {
            chatHistory = [];
            const container = document.getElementById('chatContainer');
            container.innerHTML = `
                <div class="welcome-card">
                    <h3>üíö Welcome</h3>
                    <p>
                        I'm here to listen and support you through the daily challenges of diabetes. 
                        I was trained on conversations with real people living with diabetes, so I understand 
                        the frustrations, the victories, and everything in between.
                    </p>
                    <p style="font-size: 0.8rem; color: var(--gray-500);">
                        I'm not a doctor and can't give medical advice. For medical concerns, please consult your healthcare team.
                    </p>
                    <div class="welcome-prompts">
                        <button class="prompt-btn" onclick="sendPrompt('I had a rough night with my blood sugar')">Rough night with blood sugar</button>
                        <button class="prompt-btn" onclick="sendPrompt('I\\'m frustrated with my pump')">Frustrated with my pump</button>
                        <button class="prompt-btn" onclick="sendPrompt('I need to vent about carb counting')">Carb counting struggles</button>
                        <button class="prompt-btn" onclick="sendPrompt('Anyone else exhausted from this?')">Feeling exhausted</button>
                    </div>
                </div>
            `;
        }
        
        function toggleInfo() {
            alert('SwarmHealth Diabetes Companion v1.0\n\nTrained on 1,800 conversations with people living with diabetes.\n\nYour conversations are never stored.\n\nMIT Licensed ‚Ä¢ Open Source\n\ngithub.com/swarmhealth');
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
